---
layout: post
toc: true
title: "M5 - Forecasting - Part-I"
categories: portfolio
tags: [markdown, forecasting, html, EDA, Plotly]
---

# An End-to-End Machine Learning Web App

Since summer, I have been learning a lot about computer vision from the basics as I wanted to apply those skills more in industrial automation. At the same time, many blogs and articles started screaming to create an end-to-end machine learning model to understand the engineering behind the usefulness of the machine learning model. 

So, when I came across this [applied-ml github](https://github.com/eugeneyan/applied-ml#computer-vision) by Eugene Yan, this [airbnb paper](https://medium.com/airbnb-engineering/amenity-detection-and-beyond-new-frontiers-of-computer-vision-at-airbnb-144a4441b72e) caught my eye and I was excited to apply to learn and learn new engineering skills by following this article.

This article was pretty in detail, an almost step by step method one can follow to create a business machine learning model. As I was learning new aspects of machine learning engineering, I wanted to follow the article step by step and replicate it and achieve similar results.  

## BUSINESS CASE:
#### Purpose of Project and Business case of this machine learning model:
 * The purpose of this project is to build an object detection model and be able to create an interface to use the model. Overall, I wanted to learn the skills required to build an end-to-end machine learning app. 
 * This model can help in finding the essential amenities in a house from the photos taken by the owner and adds them to the listing automatically, thereby decreasing the errors of a chance of missing out of humans. This model could help both the lister, consumer, and Airbnb to have the right list of amenities listed on the app and also become a significant factor in determining the amount of charge a listing be listed.

## Steps Involved:
  1. Gathering Data
  2. Preprocessing of the Data
  3. Model Training
  4. Evaluation and Inference
  5. Develop API
  6. Deploy the app using API


### Data Collection 
The most important part of this model is building a dataset of images of house amenities. As mentioned in the article, Airbnb took majority images from internal databse and remaining images from openimages dataset. 
But before building the dataset, they had to decide the taxonomy, amenity labels. The taxonomy here should help the specific business needs. After reviewing, they came with 40 amenity classes like kitchen, bathroom, and bedroom, such as gas stove, oven, refrigerator, bathtub, shower, towel, bed, pillow, etc. 
Being a business, they could build a huge image dataset from all sources. But being a hobby project and individual, we don't have that luxury. So the next best thing is to use the available image datasets. As I was going through the article, I observed that the Airbnb engineering team started modelling with the images from Open Image Dataset. So I thought why not me.
I went through the classes in the openimages Dataset and came with 30 house amenities classes that could be useful for my model. 
```
names: ['Bathtub', 'Bed', 'Billiard table', 'Ceiling fan', 'Coffeemaker', 'Couch', 'Countertop', 'Dishwasher', 'Fireplace', 'Fountain', 
        'Gas stove', 'Jacuzzi', 'Kitchen & dining room table', 'Microwave oven', 'Mirror', 'Oven', 'Pillow', 'Porch', 'Refrigerator', 'Shower', 
        'Sink', 'Sofa bed', 'Stairs',  'Swimming pool', 'Television', 'Toilet', 'Towel', 'Tree house', 'Washing machine', 'Wine rack'] 
```
From Opem Images dataset, I downloaded around 36k images for training, 1000 images for validation and 2500 images for testing purpose.
Now for object detection, its not just images but we also need labels. Luckily the open image dataset comes with annotation labels. I downloaded the annotations file and classes file to build the label database. 
Now creating the annotate image dataset is important part of modelling as we have to build the dataset according to the model we have selected unless we are building the model from scratch, which I am doing here.
Before creating annotation dataset, I have decide on the model I am going to use. So I started reading about all the object detection model that have been created till now. R-CNN, Fast R-CNN, YOLO, EfficientDet, Detectron2, etc. As I reading more and more, I wanted to use Detectron2 as it was the most advance detection model and also it provides the most flexibility in selecting the model from its model_zoo. But, I came across another article, where Daniel Bourke replicated the same airbnb article using Detectron2. Now I thought my project is over as already he has build and replicated it and if I do it the same I might not learning and doing any thing different. Then suddenly YOLOv5 was released and the results were also astonishing. It was using a Resnet model under and the hyper-parameters were not the flexible to change. But still I didn't to replicate the same Mr.Bourke did. So I started decide to use YOLOv5 framework to build my model. 

For Yolov5, I need the annotation database as a txt file containing the box dimensions and classes for each image. A txt file can contain many classes. This dataset is built using ```prepare.py``` which obtains modules from preprocessing and mungedata which helps in getting images ids, format annotations and create the annotations box data.

It took me around 30min to one hour to create the dataset. 

### MODEL TRAINING
With 35k images, I ended up with 50k annotated labels. Before starting training, download the yolov5 and create new yaml file containing the training and validation image paths, number of classes(30), and the class names. 

At this point we have the ingrident to train a amenities model. As mentioned on the github pages of yolov5, to train run the command 
```
python train.py --img 640 
                --batch 8 
                --epochs 60 
                --data data/airbnb.yaml 
                --cfg models/yolov5x.yaml 
                --weights '' 
                --name yolov5x_airbnb_results 
                --cache
```
I took the largest model of Yolov5 which has 89M params. I took 8 batch size with 60 epochs, mention the yaml file we created to data, yolo5x.yaml to cfg. It took me around 30hours to train from start and achieve an mAP of 0.409. Once the training starts, we can check whether the training has been set up or not by checking the automatically generated file ```train_batch0_gt.jpg``` which included the graound truth for images.  The metrics of this training are 
<img src="test_images/raw_wts_metrics.png">

Airbnb engineers estimated that an mAP of atleast 50% was need to build a minimal viable product and achieved an mAP of 68% using AutoML on 75k images. So I thought of ways to increase mAP. Even though I started with using the default hyper-parameters mentioned by the Yolov5 team, spending more computation time and money to experiment with the hyper-parameters was costly to me even by using GCP free credits. So, I looked at tranfer learning. 
As Yolov5 has already been trained on COCO dataset which has similar images dataset, I downloaded the weights of the trained model and just like the above, I started training using the downloaded weights but for only 30 epochs. This took me around 15hrs of training. The results are astonishing. As you see below for 30 epochs, the mAP has touched 49%. One can consider this as an achievements in accordance to the initial hypothesis for being minimum viable product.
<img src="test_images/results.png">

This is pretty amazing, considering the Airbnb engineers worked on AutoML for three days to achieve an accuracy of 67%. YOLOv5 is amazing.

Evaluation/Predictions:
Yolov5 provides a lot of ways to check the results on new data. We check with a bunch of dataset at once, or on single image or which url link to image, or even through the webcam. At first, I evaluated the model using the download test dataset from Open Images dataset. It contained around 2500 images and with no weight initialization (the first) model, the model was able to predict only on 1000 images but with transfer learning model, it was able to predict on more than 1250 images.I forgot to check the accuracy of these predicts, but I am confident that the predictions on these images would have been definitely more than 50% with 0.3 confidence threshold and 0.4 IOU. 
YOLOv5 also gives us the option to evaluate or predict with ensemble weights.
```
python detect.py --weights runs/exp5_yolov5x_airbnb_results/weights/best.pt runs/exp6_yolov5x_airbnb_results/weights/best.pt 
                 --source dataset/images/test/ 
                 --output output/inference_right_weights 
                 --img 640 
                 --save-txt
```
I even tested the model using images from url and some images from my house. The predictions were spot on on most of the cases. For example check at the end of this write up.

### Building an API
Now the most difficult part for me. I never has necessity to learn about APIs as I am from mechanical background. So learning flask and write an API using it for my machine learnign was really difficult for me and took a long time to come up.


### Deploying on to WEB
Unfortunately I couldn't deploy my model on to web because all free tier hosting website have an upper limit of 512mb and I couldn't get model installation below 512mb. Pytorch latest version installation itself, went more thant 512mb. 
So there, I am attaching the images of locally hosted web app images below.


![webApp-1]({{ site.url }}/assets/images/webapp-1.png)
![WebApp-2]({{ site.url }}/assets/images/webapp-2.png)
![WebApp-3]({{ site.url }}/assets/images/webapp-3.png)
![WebApp-4]({{ site.url }}/assets/images/webapp-4.png)


As you can see, the trained machine learning model web app hosted locally, the predictions are astonishing. Some of the images from my house and I was really surprised that the model was detecting those. We can also see it couldn't detect the grill in the last image.

If given more computation, this can hosted on the web and open to everyone to use.

#### Future Work
  * More hyperparameter tuning
  * Hosting on web app and mobile app, accessible to everyone
  * Collect more images and label dataset 

### Final Thoughts
With this project, I did learn a lot especially the 80% of machine learning models that is the things that happens in machine learning model development apart from building a model. I had to spend more than 100$ (ofcourse, GCP free credits) on this model training and countless hours (more than a month along with my other semseter work).
Coming to the most pressing question, can this model be used in business case now? I think definitely yes. If we go by Airbnb engineers hypothesis of having a minimum of 50% mAP to have minimum viable product, we did achieve 49.5% mAP with 15 hours of training. I think if we are able to add more images to the dataset and train for more epochs with a bit of hyperparameter tuning, we can achieve better results and cross the 50% mAP within no time. 









